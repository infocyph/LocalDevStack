#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
# shellcheck disable=SC1090
source "$ROOT/lib/bootstrap.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/io.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker_exec.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/env.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/profiles.sh"

usage(){
  cat <<USG
Usage:
  lds profiles list
  lds profiles add <p...>
  lds profiles rm  <p...>
USG
}

lds_compose_project_init
lds_env_load || true

cmd="${1:-list}"; shift || true
case "$cmd" in
  list)
    # Print current COMPOSE_PROFILES from docker/.env
    if [[ -r "$ENV_DOCKER" ]]; then
      grep -E '^COMPOSE_PROFILES=' "$ENV_DOCKER" || true
    else
      lds_warn "Missing $ENV_DOCKER"
    fi
    ;;
  add)
    ((${#@})) || die "profiles add <p...>"
    modify_profiles add "$@"
    ;;
  rm|remove|del)
    ((${#@})) || die "profiles rm <p...>"
    modify_profiles remove "$@"
    ;;
  *) usage; exit 1;;
esac
