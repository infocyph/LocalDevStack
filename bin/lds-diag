#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
# shellcheck disable=SC1090
source "$ROOT/lib/bootstrap.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/io.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker_exec.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/env.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/diag.sh"

sub="${1:-}"; shift || true
case "$sub" in
  dns) host="${1:-}"; [[ -n "$host" ]] || die "diag dns <host>"; lds_diag_dns "$host";;
  route) lds_diag_route;;
  tcp) host="${1:-}"; port="${2:-}"; [[ -n "$host" && -n "$port" ]] || die "diag tcp <host> <port>"; lds_diag_tcp "$host" "$port";;
  http) url="${1:-}"; [[ -n "$url" ]] || die "diag http <url>"; lds_diag_http_head "$url";;
  tls) host="${1:-}"; port="${2:-443}"; [[ -n "$host" ]] || die "diag tls <host> [port]"; lds_diag_tls "$host" "$port";;
  *) die "diag <dns|route|tcp|http|tls>";;
esac
