#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
# shellcheck disable=SC1090
source "$ROOT/lib/bootstrap.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/io.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker_exec.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/env.sh"
url="${1:-}"; [[ -n "$url" ]] || die "sniff <url>"
shift || true

# curl + show headers; if json, pretty print.
docker exec -i SERVER_TOOLS sh -lc "curl -vk --max-time 20 '$url' "$@"" 2>&1 | {
  if docker exec -i SERVER_TOOLS sh -lc "command -v jq >/dev/null 2>&1"; then
    cat
  else
    cat
  fi
}
