#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export LDS_ROOT="$ROOT"
source "$ROOT/lib/bootstrap.sh"
source "$ROOT/lib/io.sh"
source "$ROOT/lib/docker.sh"
source "$ROOT/lib/http.sh"

# ─────────────────────────────────────────────────────────────────────────────
# Helpers (ported from lds_X, kept local to this command)
# ─────────────────────────────────────────────────────────────────────────────

_trim() {
  local s="${1:-}"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf '%s' "$s"
}

_pick_targets_interactive() {
  local -n _targets_ref=$1
  local -a all_svcs=()
  mapfile -t all_svcs < <(docker_compose config --services 2>/dev/null || true)
  ((${#all_svcs[@]})) || die "No services found (docker compose config --services failed?)"

  echo
  echo "Select services to rebuild (comma separated; ranges allowed)."
  echo "Examples: 1,3,5-7   |   nginx,2,5-6   |   all"
  echo

  local i
  for i in "${!all_svcs[@]}"; do
    printf "  %2d) %s\n" "$((i + 1))" "${all_svcs[$i]}"
  done

  echo
  local sel
  read -r -p "Pick: " sel
  sel="$(_trim "${sel:-}")"
  [[ -n "$sel" ]] || die "No selection provided."

  if [[ "${sel,,}" == "all" ]]; then
    _targets_ref=("${all_svcs[@]}")
    return 0
  fi

  local -A seen=()
  _targets_ref=()

  _add() {
    local s="${1:-}"
    [[ -n "$s" ]] || return 0
    [[ -n "${seen[$s]:-}" ]] && return 0
    seen[$s]=1
    _targets_ref+=("$s")
  }

  local IFS=,
  local arg
  for arg in $sel; do
    arg="$(_trim "$arg")"
    [[ -n "$arg" ]] || continue

    # range 3-7
    if [[ "$arg" =~ ^[0-9]+-[0-9]+$ ]]; then
      local a b
      a="${arg%-*}"
      b="${arg#*-}"
      ((a >= 1 && b >= 1)) || continue
      if ((a > b)); then local t="$a"; a="$b"; b="$t"; fi

      local n
      for ((n=a; n<=b; n++)); do
        ((n >= 1 && n <= ${#all_svcs[@]})) || continue
        _add "${all_svcs[$((n - 1))]}"
      done
      continue
    fi

    # single index
    if [[ "$arg" =~ ^[0-9]+$ ]]; then
      local n="$arg"
      ((n >= 1 && n <= ${#all_svcs[@]})) || continue
      _add "${all_svcs[$((n - 1))]}"
      continue
    fi

    # service/container name
    local svc
    svc="$(resolve_service "$arg")"
    [[ -n "$svc" ]] && _add "$svc"
  done

  ((${#_targets_ref[@]})) || die "No valid services selected."
}

compose_image_for_service() {
  # best-effort: return image string for a service (or empty)
  local svc="${1:-}"
  [[ -n "$svc" ]] || { printf ""; return 0; }

  local json
  json="$(compose_cfg_json)"
  [[ -n "$json" ]] || { printf ""; return 0; }

  if command -v jq >/dev/null 2>&1; then
    jq -r --arg s "$svc" '.services[$s].image // ""' <<<"$json" 2>/dev/null || true
    return 0
  fi

  if command -v python3 >/dev/null 2>&1; then
    COMPOSE_CFG_JSON="$json" python3 - "$svc" <<'PY' 2>/dev/null || true
import json, os, sys
svc = sys.argv[1]
cfg = json.loads(os.environ.get("COMPOSE_CFG_JSON","") or "{}")
print(cfg.get("services", {}).get(svc, {}).get("image", "") or "")
PY
    return 0
  fi

  printf ""
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

lds_compose_project_init
compose_services_load >/dev/null 2>&1 || true

targets=()

if (($# == 0)); then
  _pick_targets_interactive targets
elif [[ "${1,,}" == "all" ]]; then
  mapfile -t targets < <(docker_compose config --services 2>/dev/null || true)
  ((${#targets[@]})) || die "No services found (docker compose config --services failed?)"
else
  declare -A seen=()
  _add_target() {
    local s="${1:-}"
    [[ -n "$s" ]] || return 0
    [[ -n "${seen[$s]:-}" ]] && return 0
    seen[$s]=1
    targets+=("$s")
  }

  for arg in "$@"; do
    arg="$(_trim "$arg")"
    [[ -n "$arg" ]] || continue
    svc="$(resolve_service "$arg")"
    [[ -n "$svc" ]] || continue
    _add_target "$svc"
  done
  ((${#targets[@]})) || die "No valid services provided."
fi

for svc in "${targets[@]}"; do
  [[ -n "$svc" ]] || continue
  compose_service_exists "$svc" || die "Unknown service/container: '$svc'"

  if compose_has_build "$svc"; then
    logq rebuild "build/recreate $svc"
    dc_build --no-cache --pull "$svc"
    dc_up -d --no-deps --force-recreate "$svc"
    continue
  fi

  img="$(compose_image_for_service "$svc")"
  logq rebuild "pull/recreate $svc${img:+ ($img)}"

  docker_compose rm -sf "$svc" >/dev/null 2>&1 || true

  if [[ -n "${img:-}" ]]; then
    docker rmi -f "$img" >/dev/null 2>&1 || true
    dc_pull "$svc" || true
  else
    dc_build --no-cache --pull "$svc" >/dev/null 2>&1 || true
  fi

  dc_up -d --no-deps --force-recreate "$svc"
done

dc_up -d
http_reload
