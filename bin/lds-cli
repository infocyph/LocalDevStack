#!/usr/bin/env bash
set -euo pipefail

# lds cli <container> [cmd...]

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# shellcheck source=../lib/bootstrap.sh
source "$DIR/lib/bootstrap.sh"
# shellcheck source=../lib/docker_exec.sh
source "$DIR/lib/docker_exec.sh"

lds_colors_init

ctr="${1:-}"
shift || true

[[ -n "$ctr" ]] || die "Usage: lds cli <container> [cmd...]"
container_exists "$ctr" || die "Container not found: $ctr"
container_running "$ctr" || die "Container not running: $ctr"

# If user provided a command, run it; otherwise open an interactive shell.
if [[ "$#" -gt 0 ]]; then
  cmd="$*"
  docker exec -it "$ctr" sh -lc '
    if command -v bash >/dev/null 2>&1; then
      exec bash --login -lc "$1"
    fi
    exec sh -lc "$1"
  ' sh "$cmd"
  exit 0
fi

docker exec -it "$ctr" sh -lc '
  if command -v bash >/dev/null 2>&1; then
    exec bash --login
  fi
  exec sh
'
