#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
# shellcheck disable=SC1090
source "$ROOT/lib/bootstrap.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/io.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/docker_exec.sh"
# shellcheck disable=SC1090
source "$ROOT/lib/env.sh"
usage(){
  cat <<USG
Usage:
  lds logs [service]
Options:
  --follow|-f
  --since <time>   (e.g. 10m, 1h)
  --grep <pat>     (uses rg in SERVER_TOOLS if available)
USG
}

lds_compose_project_init

follow=0 since="" grep_pat="" svc=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -f|--follow) follow=1; shift;;
    --since) since="${2:-}"; shift 2;;
    --grep) grep_pat="${2:-}"; shift 2;;
    -h|--help) usage; exit 0;;
    *) svc="$1"; shift; break;;
  esac
done

args=()
((follow)) && args+=("-f")
[[ -n "$since" ]] && args+=("--since" "$since")

if [[ -n "$grep_pat" ]]; then
  # stream logs then filter inside SERVER_TOOLS using rg if possible
  docker_compose logs "${args[@]}" ${svc:+"$svc"} 2>&1 | docker exec -i SERVER_TOOLS sh -lc "command -v rg >/dev/null 2>&1 && rg --line-buffered '$grep_pat' || grep -E '$grep_pat'"
else
  docker_compose logs "${args[@]}" ${svc:+"$svc"}
fi
